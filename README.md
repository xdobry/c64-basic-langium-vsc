# This is Basic Compiler-64 

It reimplement C64 Basic V2 as langium DSL project.

The project contains:

* C64 Basic language server
* Visual Studio C64 Basic plugin
* Code Formater
* Compiler for C64 that produce gcc 64-bit assembler (gas) which can be compiled and linked to executable by using gcc

It is fun project. I have made it to learn langium, x84 assembly language and build my first compiler.

# What is special about langium

C64 Basic was defined are real grammar.
Langium hat good support to make full functional language server for it.
It support validation for keywords, grammar, cross-references und types with immadiatelly display of errors in IDE.

# Alternatives

There is quite a lot alternatives to cross develop C64 Basic on moder platform.
Please check them first.
This project is in early state.

# Structure

You can see following test files

  * examples - examples of c64 basic code that is accepted by the tool.
  * examples_errors - examples of invalid c64 basic code that is recognized by the tool as errornous.
  * examples_compile - c64 basic code examples that can be compiled to 64bit executable
  * generated - GAS assembly code generated by the compiler from examples_comiple files

# Setup and install

You need node js
Use npm or pnpm

* pnpm install
* pnpm run langium:generate
* pnpm run build

# HOW TO Run

From visual studion code

* rebuild language: pnpm run langium:generate
* pnpm run build
* lunch debugger from visuals studio code. Open c64b file (see examples)

# TODO 

## Gramatik Langium

* DATA O-W,

## Langium Funktionality

* Benutzung der Variable for Validierung
* Probleme mit FOR NEXT
* Falsche Benutzung der Variablen (Syntax Error)
* Formatierung
  * Crunch
  * DeCrunch
* Tool Tips
* Basic Original Laden
* Basic Original Speichern

## Valdierung

* Unbenutzte Labels
* Unbenutzte Variablen
* Ein For ohne Next
* GOSUB ohne RETURN
* Unpassende Next
* Falsche Indexe
* Nicht eindeutige Variable Namen

# Compilation to 64 bit GAS

## String Implementierung

* Bei Variable zuweisung muss neues speicher zugewiesen werden
  * Speicher nie freigeben
  * Sonst immer freigeben
  * Besser Referenz Zähler
* Lokalen Buffer für concat benutzen bcc data bloc

## Compile Features to implement

The compiler will break with error if some unsupported keyword is used

* float arithmetics and functions
* ON GOTO, ON GOSUB
* STRING FUNCTIONS: 
    STRIING -> INT: LEN, ASC, VAL (itoa)
    INT -> STRING: STR$, CHR$
    STRING -> STRING: RIGHT$, LEFT$, MID$
* MATH functions
    SIG, ABS, RND, SIG, TAN, EXP, SQR, LOG, ATN, COS, SIN, ABS
* GET
* INPUT
* OPERATORS: AND, OR, NOT
* DATA, READ
* PEEK, POKE
 

# Testing

    npm run test

    .\node_modules\.bin\vitest run --testNamePattern "check-compile-files"

For compilation test you need gcc (64 bit) in your path

    $env:PATH += ";C:\devsoft\mingw64win\mingw64\bin"

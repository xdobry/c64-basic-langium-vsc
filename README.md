# This is Basic Compiler-64 

It reimplement C64 Basic V2 as langium DSL project.

The project contains:

* C64 Basic language server
* Visual Studio C64 Basic plugin
* Code Formater
* Compiler for C64 that produce gcc 64-bit assembler (gas) which can be compiled and linked to executable by using gcc

It is fun project. I have made it to learn langium, x84 assembly language and build my first compiler.

# What is special about langium

C64 Basic was defined are real grammar.
Langium hat good support to make full functional language server for it.
It support validation for keywords, grammar, cross-references und types with immadiatelly display of errors in IDE.

[c64 basic gramar definition](src/language/c-64-basic.langium)

# Alternatives

There is quite a lot alternatives to cross develop C64 Basic on moder platform.
Please check them first.
This project is in early state.

# Structure

You can see following test files

  * examples - examples of c64 basic code that is accepted by the tool.
  * examples_errors - examples of invalid c64 basic code that is recognized by the tool as errornous.
  * examples_compile - c64 basic code examples that can be compiled to 64bit executable
  * generated - GAS assembly code generated by the compiler from examples_comiple files

# Setup and install

You need node js
Use npm or pnpm

* pnpm install
* pnpm run langium:generate
* pnpm run build

# HOW TO Run

From visual studion code

* rebuild language: pnpm run langium:generate
* pnpm run build
* lunch debugger from visuals studio code. Open c64b file (see examples)

# TODO 

## Gramatik Langium

* DATA O-W,

## Langium Funktionality

* Benutzung der Variable for Validierung
* Probleme mit FOR NEXT
* Falsche Benutzung der Variablen (Syntax Error)
* Formatierung
  * Crunch
  * DeCrunch
* Tool Tips
* Basic Original Laden
* Basic Original Speichern

## Valdierung

* Unbenutzte Labels
* Unbenutzte Variablen
* Ein For ohne Next
* GOSUB ohne RETURN
* Unpassende Next
* Falsche Indexe
* Nicht eindeutige Variable Namen

# Compilation to 64 bit GAS

The AST (Abstract Syntax) generated by langium framework is compiled to assebler using typescript
all in one file [Assembler generator from c64 basic](src/cli/generator.ts)

There are also small c-written runtime library for some c64 commands as INPUT or string handling [C-Written runtime](ccode/rtlib.c).
This all is quite minimal so easy to experiment with it.

## String implementation

String as stored as C++String simile structure (pointer *char, lenght and capacity).
The basic string can also store null bytes.
See BString structure in rtlib.c
There are no reference counting.

    A$=B$

This will just reserve new memory and copy the string. The reserved memory is reused if possible.

## Arrays implementation

The arrays memory are allocated lazy (on access). The array structure stores rank and dimensions.
The indexes are checked of boundaries for every access.

## DEF FN implementation

The fn can be redefined.
There are also integer function possible. There must be distinct to float functions.

   DEF FN MINC(X%) = %X+1

## Compile Features to implement

The compiler will break with error if some unsupported keyword is used

* ARRAYS for INPUT and READ
* TIME, TIME$
* OPEN, INPUT#, GET#, PRINT#
* PRINT , and ;
* SPC - space
* TAB, POS
* Math Potenz ^
* REM

* TODO 
  - check stack usage for GOSUB there need be additional place under stack so each call needs to reserve some values on stack to safe "ret" address
  - set all stack mem to 0 (init)
  - check division by zero

# Incompatibilities to C64 Basic

I tried that the compiler produces code that behavious same as possible as original basic 64 interpereter
without the limitations of c64 basic.

Integer and float variables uses 64-bit numbers.
There are no limitiation on string and array dimension length.
The whole variable name is siginificant (not only 2 characters as in c64 basic).

The mathematical expression are also computed directly on integer numbers if 2 operand are also integer.
For loops can use integer variables. If you want to compile the program to x86 you may use more integer variables.
But this will not run on original c64.

For-Next loop might work differently for special cases.
Following code will work on original c64 basic but will not compile with this compiler

   10 GOTO 50
   20 PRINT I: NEXT I
   30 END
   50 FOR I=0 TO 5
   60 GOTO 20

Some commands are not implementated because they make no sense in compiled language or on windows platform.
* RUN
* LIST
* BREAK
* LOAD
* SYS
* VERIFY
* WAIT
* USR
* FRE
* NEW
* CLR

# Testing

    npm run test

    .\node_modules\.bin\vitest run --testNamePattern "check-compile-files"

For compilation test you need gcc (64 bit) in your path

    $env:PATH += ";C:\devsoft\mingw64win\mingw64\bin"

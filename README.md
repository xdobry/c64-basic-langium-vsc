# This is Basic Compiler-64 

It reimplement C64 Basic V2 as langium DSL project.

The project contains:

* C64 Basic language server
* Visual Studio C64 Basic plugin
* Code Formater
* Compiler for C64 that produce gcc 64-bit assembler (gas) which can be compiled and linked to executable by using gcc

It is fun project. I have made it to learn langium, x84 assembly language and build my first compiler.

# What is special about langium

C64 Basic was defined are real grammar.
Langium hat good support to make full functional language server for it.
It support validation for keywords, grammar, cross-references und types with immadiatelly display of errors in IDE.

[c64 basic gramar definition](src\language\c-64-basic.langium)

# Alternatives

There is quite a lot alternatives to cross develop C64 Basic on moder platform.
Please check them first.
This project is in early state.

# Structure

You can see following test files

  * examples - examples of c64 basic code that is accepted by the tool.
  * examples_errors - examples of invalid c64 basic code that is recognized by the tool as errornous.
  * examples_compile - c64 basic code examples that can be compiled to 64bit executable
  * generated - GAS assembly code generated by the compiler from examples_comiple files

# Setup and install

You need node js
Use npm or pnpm

* pnpm install
* pnpm run langium:generate
* pnpm run build

# HOW TO Run

From visual studion code

* rebuild language: pnpm run langium:generate
* pnpm run build
* lunch debugger from visuals studio code. Open c64b file (see examples)

# TODO 

## Gramatik Langium

* DATA O-W,

## Langium Funktionality

* Benutzung der Variable for Validierung
* Probleme mit FOR NEXT
* Falsche Benutzung der Variablen (Syntax Error)
* Formatierung
  * Crunch
  * DeCrunch
* Tool Tips
* Basic Original Laden
* Basic Original Speichern

## Valdierung

* Unbenutzte Labels
* Unbenutzte Variablen
* Ein For ohne Next
* GOSUB ohne RETURN
* Unpassende Next
* Falsche Indexe
* Nicht eindeutige Variable Namen

# Compilation to 64 bit GAS

The AST (Abstract Syntax) generated by langium framework is compiled to assebler using typescript
all in one file [Assembler generator from c64 basic](src/language/generated/grammar.ts)

There are also small c-written runtime library for some c64 commands as INPUT or string handling [C-Written runtime](ccode/rtlib.c).
Addionally there are also some assembler code runtime [ASM runtime](code/rtlib_asm.s)
This all is quite minimal so easy to experiment with it.

## String Implementierung

String as stored as C++String simile structure (pointer *char, lenght and capacity).
See BString structure in rtlib.c
There are no reference counting.

    A$=B$

This will just reserve new memory and copy the string. The reserved memory is reused if possible.

## Compile Features to implement

The compiler will break with error if some unsupported keyword is used

* DIM arrays
  - need to store pointer and lenght (2 vtype for each). The table is vtype for int and float and 3*vtype for string
  - store mem pointer, count of dimmensions, dimension-1, dimensions-2,  dimension-3, .... dimension-n
  - dimensions count is know at compile time
  - allocale mem if no dim is used then always 10 (allocate on access if 0 - dynamic behaviour such as in original)
  - allocation is allowed only once (this is error) - REDIM'D ARRAY
     A(4)=4
     DIM A(20)
     PRINT A(4)
  - A(x) and A - are different variables
  - special internal name A[] 
  - special code for handling in assembler (seperate file)
    - init variable set to 0
    - access variable , pointer + index (create if null)
    - dim on variable, pointer + index 
  - for calculation of element location the dimensions are needed
    
    
* ON GOTO, ON GOSUB
  - use jmp table
  - 
* OPERATORS: AND, OR, NOT
* DATA, READ
  - store all data as structure operators to read the data simmilar to input, handle the pointer to next data
  - all data could be safe as str,int und double (zeros if not possible)
  - A and A% can not read masked value DATA "2", but A$ can read DATA 2. So we do not knwo if 2 is string or number.
  - store (hasfloat, lenght of str, int data, float data, str) - can use error float to store that not number. Store in all 3 representation for speed
* PEEK, POKE
  - just reserver 64K Memory to use. Just can read and write byte values.

* TODO 
  - check stack usage for GOSUB there need be additional place under stack so each call needs to reserve some values on stack to safe "ret" address
  - set all stack mem on 0 (init)
  - VAL()
  - STR$()
  - IF A$<>B$

# Testing

    npm run test

    .\node_modules\.bin\vitest run --testNamePattern "check-compile-files"

For compilation test you need gcc (64 bit) in your path

    $env:PATH += ";C:\devsoft\mingw64win\mingw64\bin"
